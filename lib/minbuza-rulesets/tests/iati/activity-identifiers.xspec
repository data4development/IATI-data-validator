<?xml version="1.0" encoding="UTF-8"?>
<x:description xmlns:x="http://www.jenitennison.com/xslt/xspec"
  xmlns:me="http://iati.me"
  xslt-version="3.0">

  <x:scenario label="Activity identifiers">

    <x:scenario label="If an activity identifier has no value (or only whitespace)">
      <x:context>
        <iati-activity>
          <iati-identifier> </iati-identifier>
          <participating-org activity-id="  "/>
          <transaction>
            <provider-org provider-activity-id="  "/>
            <receiver-org receiver-activity-id=""/>
          </transaction>
          <other-identifier type="A3" ref="
              "/>
          <other-identifier type="B1" ref="
              "/>
          <related-activity ref="  "/>
        </iati-activity>
      </x:context>

      <x:expect label="It should produce message 1.3.7 for iati-identifier." test="boolean(//iati-identifier/me:feedback[@id='1.3.7'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//iati-identifier/me:feedback[@id='1.3.7']/@type='danger')"/>
      <x:expect label="It should produce message 1.9.7 for participating-org." test="boolean(//participating-org/me:feedback[@id='1.9.7'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//participating-org/me:feedback[@id='1.9.7']/@type='warning')"/>
      <x:expect label="It should produce message 1.4.7 for provider-org." test="boolean(//provider-org/me:feedback[@id='1.4.7'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//provider-org/me:feedback[@id='1.4.7']/@type='warning')"/>
      <x:expect label="It should produce message 1.5.7 for receiver-org." test="boolean(//receiver-org/me:feedback[@id='1.5.7'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//receiver-org/me:feedback[@id='1.5.7']/@type='warning')"/>
      <x:expect label="It should produce message 1.6.7 for other-identifier type A3." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.7'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.7']/@type='warning')"/>
      <x:expect label="It should produce message 1.16.7 for other-identifier type B1." test="boolean(//other-identifier[2]/me:feedback[@id='1.16.7'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//other-identifier[2]/me:feedback[@id='1.16.7']/@type='warning')"/>
      <x:expect label="It should produce message 1.7.7 for related-activity." test="boolean(//related-activity/me:feedback[@id='1.7.7'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//related-activity/me:feedback[@id='1.7.7']/@type='warning')"/>
    </x:scenario>

    <x:scenario label="If an activity identifier contains leading or trailing spaces">
      <x:context>
        <iati-activity>
          <iati-identifier> ABC</iati-identifier>
          <participating-org activity-id="XYZ "/>
          <transaction>
            <provider-org provider-activity-id=" A12 "/>
            <receiver-org receiver-activity-id="B23 "/>
          </transaction>
          <other-identifier type="A3" ref="
              CDE "/>
          <other-identifier type="B1" ref="
              CDE "/>
          <related-activity ref=" 123 "/>
        </iati-activity>
      </x:context>

      <x:expect label="It should produce message 1.3.1 for iati-identifier." test="boolean(//iati-identifier/me:feedback[@id='1.3.1'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//iati-identifier/me:feedback[@id='1.3.1']/@type='danger')"/>
      <x:expect label="It should produce message 1.9.1 for participating-org." test="boolean(//participating-org/me:feedback[@id='1.9.1'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//participating-org/me:feedback[@id='1.9.1']/@type='danger')"/>
      <x:expect label="It should produce message 1.4.1 for provider-org." test="boolean(//provider-org/me:feedback[@id='1.4.1'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//provider-org/me:feedback[@id='1.4.1']/@type='danger')"/>
      <x:expect label="It should produce message 1.5.1 for receiver-org." test="boolean(//receiver-org/me:feedback[@id='1.5.1'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//receiver-org/me:feedback[@id='1.5.1']/@type='danger')"/>
      <x:expect label="It should produce message 1.6.1 for other-identifier type A3." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.1'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.1']/@type='danger')"/>
      <x:expect label="It should produce message 1.16.1 for other-identifier type B1." test="boolean(//other-identifier[2]/me:feedback[@id='1.16.1'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//other-identifier[2]/me:feedback[@id='1.16.1']/@type='danger')"/>
      <x:expect label="It should produce message 1.7.1 for related-activity." test="boolean(//related-activity/me:feedback[@id='1.7.1'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//related-activity/me:feedback[@id='1.7.1']/@type='danger')"/>
    </x:scenario>

    <x:scenario label="If the activity identifier starts with a prefix that is marked 'withdrawn'">
      <x:context>
        <iati-activity>
          <iati-identifier>FR-INSEE-123</iati-identifier>
          <participating-org activity-id="GB-GOVUK-123"/>
          <transaction>
            <provider-org provider-activity-id="IT-RI-ABC"/>
            <receiver-org receiver-activity-id="KE-RSO-XYZ"/>
          </transaction>
          <other-identifier type="A3" ref="MW-CNM-12345"/>
          <other-identifier type="B1" ref="MW-CNM-12345"/>
          <related-activity ref="KE-RSO-12345"/>
        </iati-activity>
      </x:context>

      <x:expect label="It should produce message 1.3.9 for iati-identifier." test="boolean(//iati-identifier/me:feedback[@id='1.3.9'])"/>
      <x:expect label="It should be severity 'info'." test="boolean(//iati-identifier/me:feedback[@id='1.3.9']/@type='info')"/>
      <x:expect label="It should produce message 1.9.9 for participating-org." test="boolean(//participating-org/me:feedback[@id='1.9.9'])"/>
      <x:expect label="It should be severity 'info'." test="boolean(//participating-org/me:feedback[@id='1.9.9']/@type='info')"/>
      <x:expect label="It should produce message 1.4.9 for provider-org." test="boolean(//provider-org/me:feedback[@id='1.4.9'])"/>
      <x:expect label="It should be severity 'info'." test="boolean(//provider-org/me:feedback[@id='1.4.9']/@type='info')"/>
      <x:expect label="It should produce message 1.5.9 for receiver-org." test="boolean(//receiver-org/me:feedback[@id='1.5.9'])"/>
      <x:expect label="It should be severity 'info'." test="boolean(//receiver-org/me:feedback[@id='1.5.9']/@type='info')"/>
      <x:expect label="It should produce message 1.6.9 for other-identifier type A3." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.9'])"/>
      <x:expect label="It should be severity 'info'." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.9']/@type='info')"/>
      <x:expect label="It should produce message 1.16.9 for other-identifier type B1." test="boolean(//other-identifier[2]/me:feedback[@id='1.16.9'])"/>
      <x:expect label="It should be severity 'info'." test="boolean(//other-identifier[2]/me:feedback[@id='1.16.9']/@type='info')"/>
      <x:expect label="It should produce message 1.7.9 for related-activity." test="boolean(//related-activity/me:feedback[@id='1.7.9'])"/>
      <x:expect label="It should be severity 'info'." test="boolean(//related-activity/me:feedback[@id='1.7.9']/@type='info')"/>
    </x:scenario>

    <x:scenario label="If the activity identifier prefix is not in uppercase">
      <x:context>
        <iati-activity>
          <iati-identifier>FR-rcs-123</iati-identifier>
          <participating-org activity-id="GB-chc-123"/>
          <transaction>
            <provider-org provider-activity-id="bg-eik-ABC"/>
            <receiver-org receiver-activity-id="NL-KvK-XYZ"/>
          </transaction>
          <other-identifier type="A3" ref="Nl-KvK-12345"/>
          <other-identifier type="B1" ref="Nl-KvK-12345"/>
          <related-activity ref="Bg-eiK-12345"/>
        </iati-activity>
      </x:context>

      <x:expect label="It should produce message 1.3.5 for iati-identifier." test="boolean(//iati-identifier/me:feedback[@id='1.3.5'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//iati-identifier/me:feedback[@id='1.3.5']/@type='danger')"/>
      <x:expect label="It should produce message 1.9.5 for participating-org." test="boolean(//participating-org/me:feedback[@id='1.9.5'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//participating-org/me:feedback[@id='1.9.5']/@type='danger')"/>
      <x:expect label="It should produce message 1.4.5 for provider-org." test="boolean(//provider-org/me:feedback[@id='1.4.5'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//provider-org/me:feedback[@id='1.4.5']/@type='danger')"/>
      <x:expect label="It should produce message 1.5.5 for receiver-org." test="boolean(//receiver-org/me:feedback[@id='1.5.5'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//receiver-org/me:feedback[@id='1.5.5']/@type='danger')"/>
      <x:expect label="It should produce message 1.6.5 for other-identifier type A3." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.5'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.5']/@type='danger')"/>
      <x:expect label="It should produce message 1.16.5 for other-identifier type B1." test="boolean(//other-identifier[2]/me:feedback[@id='1.16.5'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//other-identifier[2]/me:feedback[@id='1.16.5']/@type='danger')"/>
      <x:expect label="It should produce message 1.7.5 for related-activity." test="boolean(//related-activity/me:feedback[@id='1.7.5'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//related-activity/me:feedback[@id='1.7.5']/@type='danger')"/>
    </x:scenario>

    <x:scenario label="If the activity identifier starts with a 5-digit code that was not on the list used up to IATI version 1.04">
      <x:context>
        <iati-activity>
          <iati-identifier>22000-123</iati-identifier>
          <participating-org activity-id="21000-123"/>
          <transaction>
            <provider-org provider-activity-id="23000-ABC"/>
            <receiver-org receiver-activity-id="21000DEF"/>
          </transaction>
          <other-identifier type="A3" ref="22000XYZ"/>
          <other-identifier type="B1" ref="22000"/>
          <related-activity ref="23000/1"/>
        </iati-activity>
      </x:context>

      <x:expect label="It should produce message 1.3.10 for iati-identifier." test="boolean(//iati-identifier/me:feedback[@id='1.3.10'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//iati-identifier/me:feedback[@id='1.3.10']/@type='danger')"/>
      <x:expect label="It should produce message 1.9.10 for participating-org." test="boolean(//participating-org/me:feedback[@id='1.9.10'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//participating-org/me:feedback[@id='1.9.10']/@type='warning')"/>
      <x:expect label="It should produce message 1.4.10 for provider-org." test="boolean(//provider-org/me:feedback[@id='1.4.10'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//provider-org/me:feedback[@id='1.4.10']/@type='warning')"/>
      <x:expect label="It should produce message 1.5.10 for receiver-org." test="boolean(//receiver-org/me:feedback[@id='1.5.10'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//receiver-org/me:feedback[@id='1.5.10']/@type='warning')"/>
      <x:expect label="It should produce message 1.6.10 for other-identifier type A3." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.10'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.10']/@type='warning')"/>
      <x:expect label="It should produce message 1.16.10 for other-identifier type B1." test="boolean(//other-identifier[2]/me:feedback[@id='1.16.10'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//other-identifier[2]/me:feedback[@id='1.16.10']/@type='warning')"/>
      <x:expect label="It should produce message 1.7.10 for related-activity." test="boolean(//related-activity/me:feedback[@id='1.7.10'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//related-activity/me:feedback[@id='1.7.10']/@type='warning')"/>
    </x:scenario>

    <x:scenario label="If the activity identifier does start with a known prefix">
      <x:context>
        <iati-activity>
          <iati-identifier>GB-GOV-1-123</iati-identifier>
          <participating-org activity-id="GB-GOV-1-123"/>
          <transaction>
            <provider-org provider-activity-id="GB-GOV-1-123-ABC"/>
            <receiver-org receiver-activity-id="GB-GOV-1-987-XYZ"/>
          </transaction>
          <other-identifier type="A3" ref="GB-GOV-1-XYZ-123"/>
          <other-identifier type="B1" ref="GB-GOV-1-XYZ-123"/>
          <related-activity ref="GB-GOV-1-45-678"/>
        </iati-activity>
      </x:context>
      
      <x:expect label="It should not produce message 1.3.8 for iati-identifier." test="not(//iati-identifier/me:feedback[@id='1.3.8'])"/>
      <x:expect label="It should not produce message 1.9.8 for participating-org." test="not(//participating-org/me:feedback[@id='1.9.8'])"/>
      <x:expect label="It should not produce message 1.4.8 for provider-org." test="not(//provider-org/me:feedback[@id='1.4.8'])"/>
      <x:expect label="It should not produce message 1.5.8 for receiver-org." test="not(//receiver-org/me:feedback[@id='1.5.8'])"/>
      <x:expect label="It should not produce message 1.6.8 for other-identifier type A3." test="not(//other-identifier[1]/me:feedback[@id='1.6.8'])"/>
      <x:expect label="It should not produce message 1.16.8 for other-identifier type B1." test="not(//other-identifier[2]/me:feedback[@id='1.16.8'])"/>
      <x:expect label="It should not produce message 1.7.8 for related-activity." test="not(//related-activity/me:feedback[@id='1.7.8'])"/>
    </x:scenario>
    
    <x:scenario label="If the activity identifier does not start with a known prefix">
      <x:context>
        <iati-activity>
          <iati-identifier>AA-Abc-123</iati-identifier>
          <participating-org activity-id="NL-XYZ-123"/>
          <transaction>
            <provider-org provider-activity-id="A12-123-ABC"/>
            <receiver-org receiver-activity-id="B23-987-XYZ"/>
          </transaction>
          <other-identifier type="A3" ref="CDE-XYZ-123"/>
          <other-identifier type="B1" ref="CDE-XYZ-123"/>
          <related-activity ref="123-45-678"/>
        </iati-activity>
      </x:context>

      <x:expect label="It should produce message 1.3.8 for iati-identifier." test="boolean(//iati-identifier/me:feedback[@id='1.3.8'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//iati-identifier/me:feedback[@id='1.3.8']/@type='danger')"/>
      <x:expect label="It should produce message 1.9.8 for participating-org." test="boolean(//participating-org/me:feedback[@id='1.9.8'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//participating-org/me:feedback[@id='1.9.8']/@type='warning')"/>
      <x:expect label="It should produce message 1.4.8 for provider-org." test="boolean(//provider-org/me:feedback[@id='1.4.8'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//provider-org/me:feedback[@id='1.4.8']/@type='warning')"/>
      <x:expect label="It should produce message 1.5.8 for receiver-org." test="boolean(//receiver-org/me:feedback[@id='1.5.8'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//receiver-org/me:feedback[@id='1.5.8']/@type='warning')"/>
      <x:expect label="It should produce message 1.6.8 for other-identifier type A3." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.8'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.8']/@type='warning')"/>
      <x:expect label="It should produce message 1.16.8 for other-identifier type B1." test="boolean(//other-identifier[2]/me:feedback[@id='1.16.8'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//other-identifier[2]/me:feedback[@id='1.16.8']/@type='warning')"/>
      <x:expect label="It should produce message 1.7.8 for related-activity." test="boolean(//related-activity/me:feedback[@id='1.7.8'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//related-activity/me:feedback[@id='1.7.8']/@type='warning')"/>
    </x:scenario>

    <x:scenario label="If the activity identifier does not start with an organisation identifier approved by the IATI Registry">
      <x:context>
        <iati-activity>
          <iati-identifier>GB-GOV-12345-ABC</iati-identifier>
          <participating-org activity-id="NL-KVK-12345678-XYZ"/>
          <transaction>
            <provider-org provider-activity-id="AU-ABN-XYZ-123"/>
            <receiver-org receiver-activity-id="CA-CC-AC-000"/>
          </transaction>
          <other-identifier type="A3" ref="XM-DAC-000-111"/>
          <related-activity ref="XI-IATI-000-111"/>
        </iati-activity>
      </x:context>

      <x:expect label="It should produce message 1.3.11 for iati-identifier." test="boolean(//iati-identifier/me:feedback[@id='1.3.11'])"/>
      <x:expect label="It should be severity 'error'." test="boolean(//iati-identifier/me:feedback[@id='1.3.11']/@type='danger')"/>
      <x:expect label="It should produce message 1.9.11 for participating-org." test="boolean(//participating-org/me:feedback[@id='1.9.11'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//participating-org/me:feedback[@id='1.9.11']/@type='warning')"/>
      <x:expect label="It should produce message 1.4.11 for provider-org." test="boolean(//provider-org/me:feedback[@id='1.4.11'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//provider-org/me:feedback[@id='1.4.11']/@type='warning')"/>
      <x:expect label="It should produce message 1.5.11 for receiver-org." test="boolean(//receiver-org/me:feedback[@id='1.5.11'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//receiver-org/me:feedback[@id='1.5.11']/@type='warning')"/>
      <x:expect label="It should produce message 1.6.11 for other-identifier type A3." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.11'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//other-identifier[1]/me:feedback[@id='1.6.11']/@type='warning')"/>
      <x:expect label="It should produce message 1.7.11 for related-activity." test="boolean(//related-activity/me:feedback[@id='1.7.11'])"/>
      <x:expect label="It should be severity 'warning'." test="boolean(//related-activity/me:feedback[@id='1.7.11']/@type='warning')"/>
    </x:scenario>

    <x:scenario label="If the activity identifier starts with a known organisation identifier">
      <x:context>
        <iati-activity>
          <iati-identifier>SE-0-123</iati-identifier>
          <participating-org activity-id="NI-MIGOB-3602-123"/>
          <transaction>
            <provider-org provider-activity-id="FR-SIRET-4028868160030-123"/>
            <receiver-org receiver-activity-id="ZA-CIPC-2001/005850/08-123"/>
          </transaction>
          <other-identifier type="A3" ref="NI-MIGOB-3602-123"/>
        </iati-activity>
      </x:context>
      
      <x:expect label="It should not produce message 1.3.* for iati-identifier." test="not(//reporting-org/me:feedback[starts-with(@id, '1.3.')])"/>
      <x:expect label="It should not produce message 1.8.* for participating-org." test="not(//participating-org/me:feedback[starts-with(@id, '1.8.')])"/>
      <x:expect label="It should not produce message 1.10.* for provider-org." test="not(//provider-org/me:feedback[starts-with(@id, '1.10.')])"/>
      <x:expect label="It should not produce message 1.15.* for receiver-org." test="not(//receiver-org/me:feedback[starts-with(@id, '1.15.')])"/>
      <x:expect label="It should not produce message 1.16.* for other-identifier type B1." test="not(//other-identifier//me:feedback[starts-with(@id, '1.16.')])"/>
    </x:scenario>
    
    <x:scenario label="If the activity identifier is not in our list of published activity identifiers">
      <x:context>
        <iati-activity>
          <participating-org activity-id="XM-DAC-7-NOT-KNOWN"/>
        </iati-activity>
      </x:context>
      <x:expect label="It should not produce message 1.8.* for participating-org/@ref." test="not(//participating-org/me:feedback[starts-with(@id, '1.8.')])"/>
      <x:expect label="It should produce message 1.9.13 for participating-org/@activity-id." test="boolean(//participating-org/me:feedback[@id='1.9.13'])"/>
      <x:expect label="It should include a property with the activity id in message 1.9.13." test="boolean(//participating-org/me:feedback[@id='1.9.13']/me:property-reference[@property='activity-identifier']='XM-DAC-7-NOT-KNOWN')"/>
    </x:scenario>

    <x:scenario label="If the activity identifier is not in our list of published activity identifiers but published in this file">
      <x:context>
        <iati-activity>
          <participating-org activity-id="XM-DAC-7-PUBLISHED-HERE"/>
        </iati-activity>
        <iati-activity>
          <iati-identifier>XM-DAC-7-PUBLISHED-HERE</iati-identifier>          
        </iati-activity>
      </x:context>
      <x:expect label="It should not produce message 1.8.* for participating-org/@ref." test="not(//participating-org/me:feedback[starts-with(@id, '1.8.')])"/>
      <x:expect label="It should not produce message 1.9.13 for participating-org/@activity-id." test="not(//participating-org/me:feedback[@id='1.9.13'])"/>
    </x:scenario>
  </x:scenario>

</x:description>
